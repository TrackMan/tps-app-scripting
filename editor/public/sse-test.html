<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Connection Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        .timestamp {
            color: #666;
            font-size: 0.9em;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
        }
        input {
            padding: 8px;
            width: 400px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>SSE Connection Diagnostic Tool</h1>
    
    <div>
        <label>Webhook Path:</label><br>
        <input type="text" id="webhookPath" value="test-sse-debug" placeholder="Enter webhook path">
        <button onclick="connect()">Connect SSE</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="sendTestEvent()">Send Test Event</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div>
        <strong>Status:</strong> <span id="status">Not connected</span><br>
        <strong>Events Received:</strong> <span id="eventCount">0</span><br>
        <strong>Last Event:</strong> <span id="lastEvent">None</span>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        let es = null;
        let eventCount = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toISOString();
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(status, className = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = className;
        }
        
        function connect() {
            if (es) {
                log('Already connected', 'error');
                return;
            }
            
            const path = document.getElementById('webhookPath').value;
            if (!path) {
                log('Please enter a webhook path', 'error');
                return;
            }
            
            const url = `/api/webhook/${encodeURIComponent(path)}/stream`;
            log(`Connecting to ${url}...`, 'info');
            
            es = new EventSource(url);
            
            es.onopen = () => {
                log('✅ SSE connection opened', 'success');
                updateStatus('Connected', 'success');
            };
            
            es.onerror = (err) => {
                log(`❌ SSE connection error - readyState: ${es?.readyState}`, 'error');
                updateStatus('Error / Disconnected', 'error');
                console.error('SSE Error:', err);
            };
            
            es.onmessage = (event) => {
                eventCount++;
                document.getElementById('eventCount').textContent = eventCount;
                
                const data = event.data;
                log(`📨 Message received (${data.length} bytes)`, 'info');
                
                try {
                    const parsed = JSON.parse(data);
                    log(`   Event Type: ${parsed.eventType || 'N/A'}`, 'info');
                    log(`   Event ID: ${parsed.id || 'N/A'}`, 'info');
                    log(`   Timestamp: ${parsed.timestamp || 'N/A'}`, 'info');
                    document.getElementById('lastEvent').textContent = parsed.eventType || 'Unknown';
                    
                    // Log full payload
                    console.log('SSE Event:', parsed);
                } catch (err) {
                    log(`   Raw data: ${data.substring(0, 100)}...`, 'info');
                }
            };
        }
        
        function disconnect() {
            if (!es) {
                log('Not connected', 'error');
                return;
            }
            
            es.close();
            es = null;
            log('Disconnected', 'info');
            updateStatus('Disconnected', 'info');
        }
        
        async function sendTestEvent() {
            const path = document.getElementById('webhookPath').value;
            if (!path) {
                log('Please enter a webhook path', 'error');
                return;
            }
            
            const url = `/api/webhook/${encodeURIComponent(path)}`;
            const payload = [{
                eventType: 'Test.SSE.Diagnostic',
                id: `test-${Date.now()}`,
                eventTime: new Date().toISOString(),
                data: {
                    message: 'Test event from SSE diagnostic tool',
                    timestamp: Date.now()
                }
            }];
            
            log(`📤 Sending test event to ${url}...`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`✅ Event sent successfully (received: ${result.received})`, 'success');
                } else {
                    log(`❌ Failed to send event: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (err) {
                log(`❌ Error sending event: ${err.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            eventCount = 0;
            document.getElementById('eventCount').textContent = '0';
        }
        
        // Auto-connect on load
        window.addEventListener('load', () => {
            log('SSE Diagnostic Tool loaded', 'info');
            log('Click "Connect SSE" to establish connection', 'info');
        });
    </script>
</body>
</html>
